# ViewBot 웹 버전 프로세스 검증

## 실행 구조

```
[브라우저] ←→ http://localhost:3000 ←→ [Node server.js]
                    │
                    ├── GET  /              → public/index.html
                    ├── GET  /api/capabilities → { puppeteer: true }
                    ├── POST /api/start      → ViewBot 생성·시작, Socket.io 이벤트
                    ├── POST /api/stop       → 봇 중지
                    ├── GET  /api/status     → running, stats, lastLogMessages
                    ├── GET  /api/log        → entries (로그 버퍼)
                    └── GET  /api/youtube-viewers?videoId=… → 시청자 수 (YOUTUBE_API_KEY 필요)
```

## 검증 순서

### 1. 서버 기동

```bash
cd c:\project\viewtest
npm install
npm run server
```

- 콘솔에 `서버가 http://localhost:3000 에서 실행 중입니다.` 출력
- 서버 시작 시 로그 버퍼에 `서버가 시작되었습니다. URL 입력 후 [봇 시작]을 누르세요.` 추가됨

### 2. 웹 UI 접속

- 브라우저에서 **http://localhost:3000** 접속
- 페이지 로드 시 `GET /` → `public/index.html` 제공
- `public/app.js`가 `/api/capabilities` 호출 → `{ puppeteer: true }` 수신 시  
  **"모드: 실제 브라우저 (플레이어 로드) · 시청자 수에 반영될 수 있습니다."** 표시

### 3. 봇 시작 (Puppeteer 모드)

1. URL 입력 (예: YouTube 라이브 URL)
2. 요청 수·최소/최대 대기(초) 설정
3. **시작** 클릭

**프로세스:**

1. `POST /api/start`  
   - Body: `{ url, instances, minDelay, maxDelay, headless }`  
   - 서버: `currentBot = new ViewBot(...)`, `currentBot.on('update', ...)` → `pushLog` + `io.emit('update')`  
   - 서버: `currentBot.on('stats', ...)` → `io.emit('stats')`  
   - 서버: `currentBot.start()` 호출, `pushLog('success', '봇이 시작되었습니다.')`  
   - 응답: `{ success: true }`

2. 웹 클라이언트  
   - Socket.io 연결 (`io()`), `socket.on('update', ...)` → 로그 영역에 메시지 추가  
   - `socket.on('stats', ...)` → 목표/진행 중/완료/실패 수 갱신  
   - `socket.on('complete', ...)` → 완료 처리 (버튼·입력 활성화 등)

3. ViewBot (`viewbot.js`)  
   - 인스턴스별 브라우저 실행 → 페이지 로드 → 시청(YouTube 시 최소 60초) → `emit('update', ...)`, `emit('stats', ...)`  
   - 모두 끝나면 `emit('complete')`

### 4. 정상 동작 확인 포인트

| 확인 항목 | 위치 | 기대 결과 |
|----------|------|-----------|
| 서버 기동 | 터미널 | `서버가 http://localhost:3000 에서 실행 중입니다.` |
| 모드 표시 | 웹 상단 힌트 | "실제 브라우저 (플레이어 로드)" 문구 |
| 시작 클릭 후 | 로그 영역 | "시작: ... (실제 브라우저 N개, 플레이어 로드)", "[인스턴스 1] 브라우저 시작...", "접속 중...", "세션 종료" 등 |
| 통계 | 통계 패널 | 목표 요청 수, 진행 중, 완료, 실패 숫자 실시간 갱신 |
| 실행 시간 | 실행 시간 | HH:MM:SS 증가 |
| YouTube URL 시 | 시청자 통계 패널 | 시작 시청자 / 현재 시청자 / 변화 (YOUTUBE_API_KEY 설정 시) |
| 완료 후 | 로그 | "완료 (실제 브라우저 모드)", 시작 버튼 다시 활성화 |

### 5. 중지

- **중지** 버튼 클릭 → `POST /api/stop` → 서버에서 `currentBot.stop()` → ViewBot이 중지 후 `emit('complete')` 등으로 클라이언트가 완료 처리

### 6. 요청 전송만 모드 (Vercel 등)

- `/api/capabilities`가 `puppeteer: false` 또는 API 실패 시  
  - 웹에서는 `runFetchMode()` 사용: `fetch(url, { mode: 'no-cors' })` 반복  
  - 시청자 수는 증가하지 않음 (분석 문서 참고)

## 요약

- **웹 버전**은 `server.js` + `public/` (index.html, app.js, style.css)로만 동작합니다.
- 봇 제어는 **POST /api/start**, **POST /api/stop**, 실시간 피드는 **Socket.io** (update, stats, complete)로 이루어집니다.
- 로그는 서버의 `logBuffer`에 쌓이고, 웹은 Socket.io `update` 이벤트로 실시간 로그를 표시합니다.
